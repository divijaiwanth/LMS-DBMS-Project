<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Library Dashboard</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="glass-container">
    <div class="top-bar">
      <h2>üìö Library Dashboard</h2>
      <button id="logoutBtn">Logout</button>
    </div>

    <div id="bookList" class="book-list">
      <!-- Books will be loaded here -->
    </div>

    <h3>Add New Book</h3>
    <form id="bookForm">
      <input type="text" name="name" placeholder="Book Name" required />
      <input type="text" name="author" placeholder="Author" required />
      <input type="text" name="isbn" placeholder="ISBN" required />
      <label>
        <input type="checkbox" name="available" />
        Available
      </label>
      <button type="submit">Add Book</button>
    </form>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    const bookList = document.getElementById("bookList");
    const form = document.getElementById("bookForm");
    const logoutBtn = document.getElementById("logoutBtn");

    if (!user) {
      window.location.href = "login.html";
    }

    logoutBtn.onclick = () => {
      localStorage.removeItem("user");
      window.location.href = "login.html";
    };

    async function fetchBooks() {
      const res = await fetch("http://localhost:3000/api/books");
      const books = await res.json();

      bookList.innerHTML = "";

      books.forEach((book) => {
        const bookCard = document.createElement("div");
        bookCard.className = "book-card";
        bookCard.innerHTML = `
          <h4>${book.name}</h4>
          <p><strong>Author:</strong> ${book.author}</p>
          <p><strong>ISBN:</strong> ${book.isbn}</p>
          <p><strong>Available:</strong> ${book.available ? "‚úÖ" : "‚ùå"}</p>
          ${user.role === "librarian" ? `
          <label class="toggle">
            <input type="checkbox" ${book.available ? "checked" : ""} onchange="toggleAvailability('${book._id}', this.checked)" />
            Toggle Availability
          </label>
          ` : ""}
        `;
        bookList.appendChild(bookCard);
      });
    }

    async function toggleAvailability(id, available) {
      const res = await fetch(`http://localhost:3000/api/books/${id}/availability`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ available }),
      });

      if (res.ok) fetchBooks();
      else alert("Error updating availability");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      data.available = formData.get("available") === "on";

      const res = await fetch("http://localhost:3000/api/books", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (res.ok) {
        form.reset();
        fetchBooks();
      } else {
        alert("Failed to add book.");
      }
    });

    fetchBooks();
  </script>
</body>
</html>
